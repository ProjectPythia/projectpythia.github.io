{"version":2,"kind":"Notebook","sha256":"b7969f5135269ac2130b5cde4d7196ab18ba46730639ae4c0bf8ee2b11cdf8d8","slug":"portal.metrics","location":"/portal/metrics.md","dependencies":[],"frontmatter":{"title":"Metrics","kernelspec":{"name":"python3","display_name":"Python 3"},"content_includes_title":false,"open_access":true,"license":{"content":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true},"code":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true}},"github":"https://github.com/projectpythia/projectpythia.github.io","keywords":[],"edit_url":"https://github.com/projectpythia/projectpythia.github.io/blob/main/portal/metrics.md","exports":[{"format":"md","filename":"metrics.md","url":"/build/metrics-f38fbf9fb8cd408cd799cda5a39e0251.md"}]},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import datetime\nimport json\nimport os\n\nimport cartopy\nimport cartopy.io\nimport google\nimport matplotlib\nimport matplotlib.cm as cm\nimport matplotlib.colors as colors\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport warnings\n\nfrom google.analytics.data_v1beta import BetaAnalyticsDataClient\nfrom google.analytics.data_v1beta.types import DateRange, Dimension, Metric, RunReportRequest\n\n# Project ID Numbers\nPORTAL_ID = '266784902'\nFOUNDATIONS_ID = '281776420'\nCOOKBOOKS_ID = '324070631'\n\n# Access Secrets\nPRIVATE_KEY_ID = os.environ.get('PRIVATE_KEY_ID')\n# Ensure GH secrets doesn't introduce extra '\\' new line characters (related to '\\' being an escape character)\nPRIVATE_KEY = os.environ.get('PRIVATE_KEY').replace('\\\\n', '\\n')\n\ncredentials_dict = {\n    'type': 'service_account',\n    'project_id': 'cisl-vast-pythia',\n    'private_key_id': PRIVATE_KEY_ID,\n    'private_key': PRIVATE_KEY,\n    'client_email': 'pythia-metrics-api@cisl-vast-pythia.iam.gserviceaccount.com',\n    'client_id': '113402578114110723940',\n    'auth_uri': 'https://accounts.google.com/o/oauth2/auth',\n    'token_uri': 'https://oauth2.googleapis.com/token',\n    'auth_provider_x509_cert_url': 'https://www.googleapis.com/oauth2/v1/certs',\n    'client_x509_cert_url': 'https://www.googleapis.com/robot/v1/metadata/x509/pythia-metrics-api%40cisl-vast-pythia.iam.gserviceaccount.com',\n    'universe_domain': 'googleapis.com',\n}\n\ntry:\n    client = BetaAnalyticsDataClient.from_service_account_info(credentials_dict)\nexcept google.auth.exceptions.MalformedError as e:\n    print('Malformed Error:', repr(e))\n    # Insight into reason for failure without exposing secret key\n    # 0: Secret not found, else malformed\n    # 706: extra quote, 732: extra '\\', 734: both\n    print('Length of PRIVATE_KEY:', len(PRIVATE_KEY))\n\npre_project_date = '2020-03-31'","visibility":"show","key":"Uq4AdVLCxF"},{"type":"output","id":"aj6bzQTptqyRaFfQ0rYXg","data":[],"visibility":"show","key":"p8lMClQ405"}],"data":{"tags":[]},"visibility":"remove","key":"TZs4AD0JRo"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":66,"column":1},"end":{"line":66,"column":1}},"children":[{"type":"text","value":"Last Updated: ","position":{"start":{"line":66,"column":1},"end":{"line":66,"column":1}},"key":"D6NYE4zADp"},{"type":"inlineExpression","value":"str(datetime.datetime.now())","key":"kWZRRWSMvY"}],"key":"QxuYD5gaEr"},{"type":"paragraph","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"This metrics page provides an overview of user activity collected by Google Analytics across the three pillars of Project Pythia: our portal which includes information about the project as well as our resource gallery, our Foundations book, and our Cookbooks gallery. Information is either all-time (from a pre-project start date of March 2020) or year-to-date as indicated and is updated nightly to provide real-time and automated insights into our engagement, impact, and audience reach. If you would like to request a different metrics analysis, timeframe, or view, please ","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"DQXBHPC7MV"},{"type":"link","url":"https://github.com/ProjectPythia/projectpythia.github.io/issues/new/choose","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"open a GitHub issue","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"FXT0ySTMrT"}],"urlSource":"https://github.com/ProjectPythia/projectpythia.github.io/issues/new/choose","error":true,"key":"PwRCBPZHnR"},{"type":"text","value":".","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"oLN6Fo5RdP"}],"key":"czghse9rcv"},{"type":"heading","depth":2,"position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"children":[{"type":"text","value":"Table of Total Active Users by Project","position":{"start":{"line":70,"column":1},"end":{"line":70,"column":1}},"key":"ZXyfCLJ8yD"}],"identifier":"table-of-total-active-users-by-project","label":"Table of Total Active Users by Project","html_id":"table-of-total-active-users-by-project","implicit":true,"key":"znI9AtWSUf"}],"key":"FCHI7ChwgD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def _format_rounding(value):\n    \"\"\"\n    Helper function for rounding string displays. 1,232 -> 1.2K\n    \"\"\"\n    return f'{round(value / 1000, 1):.1f}K'\n\n\n# The rest of this file alternates between functions for requesting information from Google Analytics\n# And functions that use that request image to form either a .json or a .png file to be used in write-metrics-md.py\ndef _run_total_users_report(property_id):\n    \"\"\"\n    Function for requesting cumulative active users from a project since project start.\n    \"\"\"\n    request = RunReportRequest(\n        property=f'properties/{property_id}',\n        dimensions=[],\n        metrics=[Metric(name='activeUsers')],\n        date_ranges=[DateRange(start_date=pre_project_date, end_date='today')],\n    )\n    response = client.run_report(request)\n\n    total_users = 0\n    for row in response.rows:\n        total_users += int(row.metric_values[0].value)\n\n    return _format_rounding(total_users)","visibility":"show","key":"jVqeyOJK1a"},{"type":"output","id":"uysuXdE-cxlK2GCgowGvV","data":[],"visibility":"show","key":"O1aTyEb6Hn"}],"data":{"tags":[]},"visibility":"remove","key":"tGYEJBh618"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"children":[{"type":"text","value":"This table displays the total active users of our 3 Pythia projects over the life of Project Pythia. Google analytics defines active users as the number of unique people who have visited the site and met certain ","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"gittiaTmY0"},{"type":"link","url":"https://support.google.com/analytics/answer/9234069?sjid=8697784525616937194-NC","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"children":[{"type":"text","value":"engagement requirements","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"ADjmYXx0WA"}],"urlSource":"https://support.google.com/analytics/answer/9234069?sjid=8697784525616937194-NC","key":"QtgXl0JQgX"},{"type":"text","value":". You can read more from the ","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"VlXjXu5DAd"},{"type":"link","url":"https://support.google.com/analytics/answer/12253918?hl=en","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"children":[{"type":"text","value":"GA4 “Understand User Metrics” documentation","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"KoSkEu5KfY"}],"urlSource":"https://support.google.com/analytics/answer/12253918?hl=en","key":"BJx3OIN7m3"},{"type":"text","value":".","position":{"start":{"line":103,"column":1},"end":{"line":103,"column":1}},"key":"jUzUX4H6RT"}],"key":"KkaWfsaXJy"}],"key":"DNUk33I1oR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"portal_users = _run_total_users_report(PORTAL_ID)\nfoundations_users = _run_total_users_report(FOUNDATIONS_ID)\ncookbooks_users = _run_total_users_report(COOKBOOKS_ID)","visibility":"show","key":"MfJFKa4CW4"},{"type":"output","id":"-qSp-mP8T22AspSPlUJGm","data":[],"visibility":"show","key":"GjVIJ525oT"}],"data":{"tags":[]},"visibility":"remove","key":"UZBsihtNq2"},{"type":"block","children":[{"type":"table","position":{"start":{"line":114,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":114,"column":1},"end":{"line":114,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":114,"column":1},"end":{"line":114,"column":1}},"children":[{"type":"text","value":"Project","position":{"start":{"line":114,"column":1},"end":{"line":114,"column":1}},"key":"lyDnpbY2xE"}],"key":"SmQKIj7aS6"},{"type":"tableCell","header":true,"position":{"start":{"line":114,"column":1},"end":{"line":114,"column":1}},"children":[{"type":"text","value":"All-Time Users","position":{"start":{"line":114,"column":1},"end":{"line":114,"column":1}},"key":"ubqyh8afdM"}],"key":"eaw6aWPXfB"}],"key":"gZvoTUxZja"},{"type":"tableRow","position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"children":[{"type":"text","value":"Portal","position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"key":"lWTm32EyWq"}],"key":"X7hk8oO34r"},{"type":"tableCell","position":{"start":{"line":116,"column":1},"end":{"line":116,"column":1}},"children":[{"type":"inlineExpression","value":"portal_users","key":"ol6m9MVH8L"}],"key":"dk7XDu5gEG"}],"key":"x8RR8Ul9Hb"},{"type":"tableRow","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"text","value":"Foundations","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"rxVGrzimtb"}],"key":"EKkeqHN5af"},{"type":"tableCell","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"children":[{"type":"inlineExpression","value":"foundations_users","key":"em77gIih42"}],"key":"kY8VBrKApe"}],"key":"c3q1AEPog2"},{"type":"tableRow","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"text","value":"Cookbooks","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"key":"W8dUy3syoE"}],"key":"EJW4MfXbaQ"},{"type":"tableCell","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"inlineExpression","value":"cookbooks_users","key":"RDyjEALRU5"}],"key":"Xyp6rq8IFK"}],"key":"IjFaR67Umo"}],"label":"table-total-users","identifier":"table-total-users","html_id":"table-total-users","enumerator":"1","key":"VoaeblE5I5"},{"type":"heading","depth":2,"position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"Chart of Active Users by Project Since Year Start","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"QeHfDCik2v"}],"identifier":"chart-of-active-users-by-project-since-year-start","label":"Chart of Active Users by Project Since Year Start","html_id":"chart-of-active-users-by-project-since-year-start","implicit":true,"key":"SAWFmrO8bx"}],"key":"n9ezICkiXY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def _run_active_users_this_year(property_id):\n    \"\"\"\n    Function for requesting active users by day from a project since year start.\n    \"\"\"\n    current_year = datetime.datetime.now().year\n    start_date = f'{current_year}-01-01'\n\n    request = RunReportRequest(\n        property=f'properties/{property_id}',\n        dimensions=[Dimension(name='date')],\n        metrics=[Metric(name='activeUsers')],\n        date_ranges=[DateRange(start_date=start_date, end_date='today')],\n    )\n    response = client.run_report(request)\n\n    dates = []\n    user_counts = []\n    for row in response.rows:\n        date_str = row.dimension_values[0].value\n        date = datetime.datetime.strptime(date_str, '%Y%m%d')\n        dates.append(date)\n        user_counts.append(int(row.metric_values[0].value))\n\n    # Days need to be sorted chronologically\n    return zip(*sorted(zip(dates, user_counts), key=lambda x: x[0]))\n\n\ndef plot_projects_this_year(PORTAL_ID, FOUNDATIONS_ID, COOKBOOKS_ID):\n    \"\"\"\n    Function for taking year-to-date active users by day and plotting it for each project.\n    \"\"\"\n    portal_dates, portal_users = _run_active_users_this_year(PORTAL_ID)\n    foundations_dates, foundations_users = _run_active_users_this_year(FOUNDATIONS_ID)\n    cookbooks_dates, cookbooks_users = _run_active_users_this_year(COOKBOOKS_ID)\n\n    # Plotting code\n    plt.figure(figsize=(10, 5.5))\n    plt.title('Year-to-Date Pythia Active Users', fontsize=15)\n\n    plt.plot(portal_dates, portal_users, color='purple', label='Portal')\n    plt.plot(foundations_dates, foundations_users, color='royalblue', label='Foundations')\n    plt.plot(cookbooks_dates, cookbooks_users, color='indianred', label='Cookbooks')\n\n    plt.legend(fontsize=12, loc='upper right')\n\n    plt.xlabel('Date', fontsize=12)\n    plt.show()","visibility":"show","key":"AINCHy0P8Y"},{"type":"output","id":"QBCErYhWI41DpLE5OhwA9","data":[],"visibility":"show","key":"yLa6bpyKTi"}],"data":{"tags":[]},"visibility":"remove","key":"KlG6YSp6Jx"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":175,"column":1},"end":{"line":175,"column":1}},"children":[{"type":"text","value":"This line plot displays active users for our 3 Pythia projects (Portal in purple, Foundations in blue, and Cookbooks in salmon) since January 1st of the current year.","position":{"start":{"line":175,"column":1},"end":{"line":175,"column":1}},"key":"IXpkWeiIV6"}],"key":"eQxh4buxMk"}],"key":"VQwNv6dlwC"},{"type":"block","kind":"notebook-code","children":[{"type":"container","kind":"figure","label":"plot-active-users","identifier":"plot-active-users","children":[{"type":"code","lang":"python","executable":true,"value":"plot_projects_this_year(PORTAL_ID, FOUNDATIONS_ID, COOKBOOKS_ID)","identifier":"plot-active-users-code","visibility":"remove","enumerator":"1","html_id":"plot-active-users-code","key":"FZ7sHchcUq"},{"type":"output","id":"XmdunaDXTSzmn1LsfmfOY","data":[],"identifier":"plot-active-users-output","visibility":"show","html_id":"plot-active-users-output","key":"qMRhRBfYjr"},{"type":"caption","children":[{"type":"paragraph","children":[{"type":"captionNumber","kind":"figure","label":"plot-active-users","identifier":"plot-active-users","html_id":"plot-active-users","enumerator":"1","children":[{"type":"text","value":"Figure ","key":"s8MNcExAgh"},{"type":"text","value":"1","key":"vIpqhKHMk9"},{"type":"text","value":":","key":"W771eUojFV"}],"template":"Figure %s:","key":"B5RwbYnPTs"},{"type":"text","value":"Chart of active users by project since year start.","position":{"start":{"line":180,"column":1},"end":{"line":180,"column":1}},"key":"OUs6x6r77M"}],"key":"kzldqJowz1"}],"key":"fdoBV9PXL0"}],"noSubcontainers":true,"enumerator":"1","html_id":"plot-active-users","key":"ChL4hUICNs"}],"data":{"tags":[]},"visibility":"show","key":"DroY2Lwk3V"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":185,"column":1},"end":{"line":185,"column":1}},"children":[{"type":"text","value":"Chart of Top 5 Pages by Project","position":{"start":{"line":185,"column":1},"end":{"line":185,"column":1}},"key":"PhYUTysnN4"}],"identifier":"chart-of-top-5-pages-by-project","label":"Chart of Top 5 Pages by Project","html_id":"chart-of-top-5-pages-by-project","implicit":true,"key":"BNHy03H4Qd"}],"key":"iKasejtzXJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def _run_top_pages_report(property_id):\n    \"\"\"\n    Function for requesting top 5 pages from a project.\n    \"\"\"\n    request = RunReportRequest(\n        property=f'properties/{property_id}',\n        dimensions=[Dimension(name='pageTitle')],\n        date_ranges=[DateRange(start_date=pre_project_date, end_date='today')],\n        metrics=[Metric(name='screenPageViews')],\n    )\n    response = client.run_report(request)\n\n    views_dict = {}\n    for row in response.rows:\n        page = row.dimension_values[0].value\n        views = int(row.metric_values[0].value)\n        views_dict[page] = views\n\n    # Sort by views and grab the top 5\n    top_pages = sorted(views_dict.items(), key=lambda item: item[1], reverse=True)[:5]\n    # String manipulation on page titles \"Cartopy - Pythia Foundations\" -> \"Cartopy\"\n    pages = [page.split('—')[0] for page, _ in top_pages]\n    views = [views for _, views in top_pages]\n\n    #  Reverse order of lists, so they'll plot with most visited page on top (i.e. last)\n    return pages[::-1], views[::-1]\ndef plot_top_pages(PORTAL_ID, FOUNDATIONS_ID, COOKBOOKS_ID):\n    \"\"\"\n    Function that takes the top 5 viewed pages for all 3 projects and plot them on a histogram.\n    \"\"\"\n    portal_pages, portal_views = _run_top_pages_report(PORTAL_ID)\n    foundations_pages, foundations_views = _run_top_pages_report(FOUNDATIONS_ID)\n    cookbooks_pages, cookbooks_views = _run_top_pages_report(COOKBOOKS_ID)\n\n    # Plotting code\n    fig, ax = plt.subplots(figsize=(10, 5.5))\n    plt.title('All-Time Top Pages', fontsize=15)\n\n    y = np.arange(5)  # 0-4 for Cookbooks\n    y2 = np.arange(6, 11)  # 6-10 for Foundations\n    y3 = np.arange(12, 17)  # 12-16 for Portal\n\n    bar1 = ax.barh(y3, portal_views, align='center', label='Portal', color='purple')\n    bar2 = ax.barh(y2, foundations_views, align='center', label='Foundations', color='royalblue')\n    bar3 = ax.barh(y, cookbooks_views, align='center', label='Cookbooks', color='indianred')\n\n    y4 = np.append(y, y2)\n    y4 = np.append(y4, y3)  # 0-4,6-19,12-6 for page labels to have a gap between projects\n    pages = cookbooks_pages + foundations_pages + portal_pages  # List of all pages\n    ax.set_yticks(y4, labels=pages, fontsize=12)\n\n    # Adds round-formatted views label to end of each bar\n    ax.bar_label(bar1, fmt=_format_rounding, padding=5, fontsize=10)\n    ax.bar_label(bar2, fmt=_format_rounding, padding=5, fontsize=10)\n    ax.bar_label(bar3, fmt=_format_rounding, padding=5, fontsize=10)\n\n    ax.set_xscale('log')\n    ax.set_xlim([10, 10**5])  # set_xlim must be after setting xscale to log\n    ax.set_xlabel('Page Views', fontsize=12)\n\n    plt.legend(fontsize=12, loc='lower right')\n    plt.show()","visibility":"show","key":"TZMmwPcIbC"},{"type":"output","id":"_GNkoB1iSoqErUmktaGg0","data":[],"visibility":"show","key":"NUM2r3r1S4"}],"data":{"tags":[]},"visibility":"remove","key":"o1yBdvoLsm"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"children":[{"type":"text","value":"This bar-chart displays the top 5 pages by project over the life of Project Pythia, as determined by screen page views. Screen page views refers to the number of times users viewed a page, including repeated visits. To learn more visit the ","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"moELzQOD3t"},{"type":"link","url":"https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"children":[{"type":"text","value":"GA4 “API Dimensions & Metrics” page","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"tKmXgdBj5U"}],"urlSource":"https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema","key":"CddCZe4bqR"},{"type":"text","value":".","position":{"start":{"line":254,"column":1},"end":{"line":254,"column":1}},"key":"HQeqYzD1OI"}],"key":"NjWj6Uw1Gw"}],"key":"WOUoD0oAcM"},{"type":"block","kind":"notebook-code","children":[{"type":"container","kind":"figure","label":"chart-top-five-pages","identifier":"chart-top-five-pages","children":[{"type":"code","lang":"python","executable":true,"value":"plot_top_pages(PORTAL_ID, FOUNDATIONS_ID, COOKBOOKS_ID)","identifier":"chart-top-five-pages-code","visibility":"remove","enumerator":"2","html_id":"chart-top-five-pages-code","key":"Ot6kff7Oi5"},{"type":"output","id":"2DstQW-zGGSSLnrXWBVD3","data":[],"identifier":"chart-top-five-pages-output","visibility":"show","html_id":"chart-top-five-pages-output","key":"NkpuY0G4ya"},{"type":"caption","children":[{"type":"paragraph","children":[{"type":"captionNumber","kind":"figure","label":"chart-top-five-pages","identifier":"chart-top-five-pages","html_id":"chart-top-five-pages","enumerator":"2","children":[{"type":"text","value":"Figure ","key":"SVzKCyXJ8x"},{"type":"text","value":"2","key":"repbhrtdFw"},{"type":"text","value":":","key":"fLcXRuyec2"}],"template":"Figure %s:","key":"wLv81XjftW"},{"type":"text","value":"Bar chart of the top five pages by project over the life of Project Pythia","position":{"start":{"line":259,"column":1},"end":{"line":259,"column":1}},"key":"LKIwxQP2lC"}],"key":"MkWmyJA7r7"}],"key":"phx7IL2A9K"}],"noSubcontainers":true,"enumerator":"2","html_id":"chart-top-five-pages","key":"DZTUlZcZOt"}],"data":{"tags":[]},"visibility":"show","key":"QI1v7brdks"},{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":264,"column":1},"end":{"line":264,"column":1}},"children":[{"type":"text","value":"Map of Total Foundation Active Users by Country","position":{"start":{"line":264,"column":1},"end":{"line":264,"column":1}},"key":"gaYJYLHm3v"}],"identifier":"map-of-total-foundation-active-users-by-country","label":"Map of Total Foundation Active Users by Country","html_id":"map-of-total-foundation-active-users-by-country","implicit":true,"key":"HcnRGCZ5gP"}],"key":"PtrmZQ1mcw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Disable cartopy warning\nwarnings.filterwarnings('ignore', category=cartopy.io.DownloadWarning)\n\ndef _run_usersXcountry_report(property_id):\n    \"\"\"\n    Function for requesting users by country for a project.\n    \"\"\"\n    request = RunReportRequest(\n        property=f'properties/{property_id}',\n        dimensions=[Dimension(name='country')],\n        metrics=[Metric(name='activeUsers')],\n        date_ranges=[DateRange(start_date=pre_project_date, end_date='today')],\n    )\n    response = client.run_report(request)\n\n    user_by_country = {}\n    for row in response.rows:\n        country = row.dimension_values[0].value\n        users = int(row.metric_values[0].value)\n        user_by_country[country] = user_by_country.get(country, 0) + users\n\n    return user_by_country\ndef plot_usersXcountry(FOUNDATIONS_ID):\n    \"\"\"\n    Function for taking users by country for Pythia Foundations and plotting them on a map.\n    \"\"\"\n    users_by_country = _run_usersXcountry_report(FOUNDATIONS_ID)\n\n    # Google API Country names do not match Cartopy Country Shapefile names\n    dict_api2cartopy = {\n        'Tanzania': 'United Republic of Tanzania',\n        'United States': 'United States of America',\n        'Congo - Kinshasa': 'Democratic Republic of the Congo',\n        'Bahamas': 'The Bahamas',\n        'Timor-Leste': 'East Timor',\n        'C\\u00f4te d\\u2019Ivoire': 'Ivory Coast',\n        'Bosnia & Herzegovina': 'Bosnia and Herzegovina',\n        'Serbia': 'Republic of Serbia',\n        'Trinidad & Tobago': 'Trinidad and Tobago',\n    }\n\n    for key in dict_api2cartopy:\n        users_by_country[dict_api2cartopy[key]] = users_by_country.pop(key)\n\n    # Sort by views and grab the top 10 countries for a text box\n    top_10_countries = sorted(users_by_country.items(), key=lambda item: item[1], reverse=True)[:10]\n    top_10_text = '\\n'.join(\n        f'{country}: {_format_rounding(value)}' for i, (country, value) in enumerate(top_10_countries)\n    )\n\n    # Plotting code\n    fig = plt.figure(figsize=(10, 4))\n    ax = plt.axes(projection=cartopy.crs.PlateCarree(), frameon=False)\n    ax.set_title('All-Time Pythia Foundations Users by Country', fontsize=15)\n\n    shapefile = cartopy.io.shapereader.natural_earth(category='cultural', resolution='110m', name='admin_0_countries')\n    reader = cartopy.io.shapereader.Reader(shapefile)\n    countries = reader.records()\n\n    colormap = plt.get_cmap('Blues')\n    newcmp = colors.ListedColormap(colormap(np.linspace(0.2, 1, 128)))  # Truncate colormap to remove white hues\n    newcmp.set_extremes(under='grey')\n\n    norm = colors.LogNorm(vmin=1, vmax=max(users_by_country.values()))  # Plot on log scale\n    mappable = cm.ScalarMappable(norm=norm, cmap=newcmp)\n\n    # Loop through countries and plot their color\n    for country in countries:\n        country_name = country.attributes['SOVEREIGNT']\n        if country_name in users_by_country.keys():\n            facecolor = newcmp(norm(users_by_country[country_name]))\n            ax.add_geometries(\n                [country.geometry],\n                cartopy.crs.PlateCarree(),\n                facecolor=facecolor,\n                edgecolor='white',\n                linewidth=0.7,\n                norm=matplotlib.colors.LogNorm(),\n            )\n        else:\n            ax.add_geometries(\n                [country.geometry], cartopy.crs.PlateCarree(), facecolor='grey', edgecolor='white', linewidth=0.7\n            )\n\n    # Add colorbar\n    cax = fig.add_axes([0.05, -0.015, 0.7, 0.03])  # [x0, y0, width, height]\n    cbar = fig.colorbar(mappable=mappable, cax=cax, spacing='uniform', orientation='horizontal', extend='min')\n    cbar.set_label('Unique Users')\n\n    # Add top 10 countries text\n    props = dict(boxstyle='round', facecolor='white', edgecolor='white')\n    ax.text(1.01, 0.5, top_10_text, transform=ax.transAxes, fontsize=12, verticalalignment='center', bbox=props)\n\n    plt.show()","visibility":"show","key":"k4WfSnw7lf"},{"type":"output","id":"P18-6-CURBbdbF9ToiD-W","data":[],"visibility":"show","key":"sqLOk3ADfu"}],"data":{"tags":[]},"visibility":"remove","key":"IhGEIQPcVz"},{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":365,"column":1},"end":{"line":365,"column":1}},"children":[{"type":"text","value":"This map displays the number of active users per country for Pythia Foundations for the entire life of Project Pythia.","position":{"start":{"line":365,"column":1},"end":{"line":365,"column":1}},"key":"w0V7TSIU4R"}],"key":"WvWCuipOSw"}],"key":"TCS72sOHEs"},{"type":"block","kind":"notebook-code","children":[{"type":"container","kind":"figure","label":"map-active-users-country","identifier":"map-active-users-country","children":[{"type":"code","lang":"python","executable":true,"value":"plot_usersXcountry(FOUNDATIONS_ID)","identifier":"map-active-users-country-code","visibility":"remove","enumerator":"3","html_id":"map-active-users-country-code","key":"elCW9uuBk2"},{"type":"output","id":"tH0DWs7kglR1ICm1E0Ho9","data":[],"identifier":"map-active-users-country-output","visibility":"show","html_id":"map-active-users-country-output","key":"NMf4UGqEgk"},{"type":"caption","children":[{"type":"paragraph","children":[{"type":"captionNumber","kind":"figure","label":"map-active-users-country","identifier":"map-active-users-country","html_id":"map-active-users-country","enumerator":"3","children":[{"type":"text","value":"Figure ","key":"c4tMNZOCiJ"},{"type":"text","value":"3","key":"ym64UhzQxK"},{"type":"text","value":":","key":"ZOSKC7nFBL"}],"template":"Figure %s:","key":"frUhpuo3Gl"},{"type":"text","value":"Map of the number of active users per country for Pythia Foundations for the entire life of Project Pythia.","position":{"start":{"line":370,"column":1},"end":{"line":370,"column":1}},"key":"Wx3aBNhDlK"}],"key":"XR8oMnlMAZ"}],"key":"CAKAnpeS3u"}],"noSubcontainers":true,"enumerator":"3","html_id":"map-active-users-country","key":"vpUxquWsET"}],"data":{"tags":[]},"visibility":"show","key":"qUuuPzFxaa"}],"key":"cxvZmSPvQ5"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Cookbook Contributor’s Guide","url":"/portal/cookbook-guide","group":"Blog"}}},"domain":"http://localhost:3000"}